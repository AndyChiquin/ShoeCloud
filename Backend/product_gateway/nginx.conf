events {}

http {
    server {
        listen 80;

         # -------- catalogService --------

        # POST /api/products/ → crear producto
        # GET /api/products/ → obtener todos los productos
        location /api/products/ {
            limit_except POST {
                proxy_pass http://13.216.150.108:3001; # GET
            }
            proxy_pass http://13.216.150.108:3000;     # POST
        }

        # GET, PUT, DELETE /api/products/<id> → diferentes servicios
        location ~ ^/api/products/([0-9a-zA-Z\-]+)$ {
            if ($request_method = GET) {
                proxy_pass http://13.216.150.108:3001;
            }
            if ($request_method = PUT) {
                proxy_pass http://13.216.150.108:3002;
            }
            if ($request_method = DELETE) {
                proxy_pass http://13.216.150.108:3003;
            }
        }



         # -------- inventoryService --------

        # POST /api/inventory → crear inventario
        # GET /api/inventory → obtener todos
        location /api/inventory {
            limit_except POST {
                proxy_pass http://13.216.150.108:3005;  # GET
            }
            proxy_pass http://13.216.150.108:3004;      # POST
        }

        # GET, PUT, DELETE /api/inventory/<id> → diferentes servicios
        location ~ ^/api/inventory/([0-9a-zA-Z\-]+)$ {
            if ($request_method = GET) {
                proxy_pass http://13.216.150.108:3005;
            }
            if ($request_method = PUT) {
                proxy_pass http://13.216.150.108:3006;
            }
            if ($request_method = DELETE) {
                proxy_pass http://13.216.150.108:3007;
            }
        }




        # -------- categoryService --------

        # POST /api/category → crear categoría
        # GET /api/category → obtener todas
        location /api/category {
            limit_except POST {
                proxy_pass http://34.200.87.1:3009;  # GET
            }
            proxy_pass http://34.200.87.1:3008;      # POST
        }

        # PUT, DELETE /api/category/<id> → actualizar y eliminar categoría
        location ~ ^/api/category/([0-9a-zA-Z\-]+)$ {
            if ($request_method = PUT) {
                proxy_pass http://34.200.87.1:3010;
            }
            if ($request_method = DELETE) {
                proxy_pass http://34.200.87.1:3011;
            }
        }



        
        # -------- imageService --------

        # GET /api/images → obtener todas las imágenes
        location = /api/images {
            limit_except GET {
                deny all;
            }
            proxy_pass http://34.200.87.1:3013;
        }

        # POST /api/images/ → crear imagen
        location = /api/images/ {
            limit_except POST {
                deny all;
            }
            proxy_pass http://34.200.87.1:3012;
        }

        # GET, PUT, DELETE /api/images/<product_id> → diferentes acciones
        location ~ ^/api/images/([0-9a-zA-Z\-]+)$ {
            if ($request_method = GET) {
                proxy_pass http://34.200.87.1:3013;
            }
            if ($request_method = PUT) {
                proxy_pass http://34.200.87.1:3014;
            }
            if ($request_method = DELETE) {
                proxy_pass http://34.200.87.1:3015;
            }
        }



        # -------- searchService --------

        # GET /search → buscar producto
        location /search {
            limit_except GET {
                deny all;
            }
            proxy_pass http://52.2.232.26:3016;
        }

        # POST /index → indexar producto
        location = /index {
            limit_except POST {
                deny all;
            }
            proxy_pass http://52.2.232.26:3017;
        }


        
        
        # -------- pricingService (WebSocket) --------

        # WS → CREATE
        location /ws/price/create {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://52.2.232.26:3018;
        }

        # WS → READ
        location /ws/price/read {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://52.2.232.26:3019;
        }

        # WS → UPDATE
        location /ws/price/update {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://34.198.245.223:3020;
        }

        # WS → DELETE
        location /ws/price/delete {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_pass http://34.198.245.223:3021;
        }


    }
}